<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $location, $rootScope, spUtil) {
  /* widget controller */
  var c = this;
	c.DEBUG = false;
	
	c.onKBClick = function(kbItem) {
		console.log('kbItem: ' + JSON.stringify(kbItem));
	}
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.v-align {
  display: inline-block;
  padding-top: 8px;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>mu-contributor-table</id>
        <internal>false</internal>
        <link/>
        <name>MU Contributor Table</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
	kbURL = "sp?id=kb_article&sys_id=";
	data.kb_fields = ['kb_category','short_description'];
	data.user_fields = ['first_name', 'last_name', 'name'];
	data.contributorList = getArticles();
	
	function getArticles() {
		var kbBaseGr = getKnowledgeBaseWithTitle('MeetUp');
		var contributorList = [];
		var aggAuthor = new GlideAggregate('x_steas_meetup_con_content');
		aggAuthor.addQuery('author', '!=', '');
		//aggAuthor.addQuery('workflow_state', 'published');
		if(kbBaseGr) {
			aggAuthor.addQuery('kb_knowledge_base', kbBaseGr.sys_id);
		}
		aggAuthor.groupBy('author');
		aggAuthor.query();
		while(aggAuthor.next()) {
			var contributor = {};
			var userGr = new GlideRecord('sys_user');
			userGr.get(aggAuthor.author);
			$sp.getRecordValues(contributor, userGr, data.user_fields);
			contributor.sys_id = userGr.sys_id + '';
			
			var kbGr = new GlideRecord('x_steas_meetup_con_content');
			kbGr.addQuery('author', aggAuthor.author);
			//kbGr.addQuery('workflow_state', 'published');
			if(kbBaseGr) {
				kbGr.addQuery('kb_knowledge_base', kbBaseGr.sys_id);
			}
			kbGr.query();
			if(!data.kb_labels || data.kb_labels.length <= 0) {
				data.kb_labels = $sp.getFields(kbGr, data.kb_fields);
			}
			contributor.count = kbGr.getRowCount();
			contributor.kb_list = [];
			while(kbGr.next()) {
				var knowledge = {};
				//$sp.getRecordValues(knowledge, kbGr, data.kb_fields);
				$sp.getRecordDisplayValues(knowledge, kbGr, data.kb_fields);
				knowledge.sys_id = kbGr.sys_id + '';
				knowledge.url = kbURL + kbGr.sys_id;
				contributor.kb_list.push(knowledge);
			}
			contributorList.push(contributor);
		}
		
		return contributorList;
	}
	
	function getKnowledgeBaseWithTitle(baseTitle) {
		if(!baseTitle) {
			return null;
		}
		
		var kbBaseGr = new GlideRecord('kb_knowledge_base');
		kbBaseGr.addQuery('title', baseTitle);
		kbBaseGr.query();
		if(kbBaseGr.next()) {
			return kbBaseGr;
		}
		return null;
	}

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>bahonur.nasritdinov@soprasteria.com</sys_created_by>
        <sys_created_on>2018-09-27 13:20:43</sys_created_on>
        <sys_id>e62410f1dbb82b80a99f70bdae96192a</sys_id>
        <sys_mod_count>149</sys_mod_count>
        <sys_name>MU Contributor Table</sys_name>
        <sys_package display_value="Meetup Content Sharing" source="x_steas_meetup_con">342b1cd24ff31340999cfdb28110c787</sys_package>
        <sys_policy/>
        <sys_scope display_value="Meetup Content Sharing">342b1cd24ff31340999cfdb28110c787</sys_scope>
        <sys_update_name>sp_widget_e62410f1dbb82b80a99f70bdae96192a</sys_update_name>
        <sys_updated_by>bahonur.nasritdinov@soprasteria.com</sys_updated_by>
        <sys_updated_on>2018-10-29 16:26:23</sys_updated_on>
        <template><![CDATA[<div class="panel">
  <div class="panel-heading panel-title">
    {{::c.options.title}}
  </div>
  
  <div class="panel-group" id="accordion">
    <div class="panel panel-default" ng-repeat="item in data.contributorList track by item['sys_id']">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a data-toggle="collapse" data-parent="#accordion" href="#{{item.sys_id}}">
            <div class="row">
              <div class="col-sm-2 col-md-2 col-xs-2">
                <sn-avatar class="avatar-small-medium" primary="item.sys_id" show-presence="true"/>
              </div>
              <div class="col-sm-8 col-md-8 col-xs-8 v-align">
                <span>{{item.name}}</span>
              </div>
              <div class="col-sm-2 col-md-2 col-xs-2 v-align">
                <span class="badge badge-pill badge-success pull-right">{{item.count}}</span>
              </div>
            </div>
          </a>
        </h4>
      </div>
      <div id="{{item.sys_id}}" class="panel-collapse collapse">
        <div class="panel-body table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th ng-repeat="label in data.kb_labels">
                  <span>{{label.label}}</span>
                </th>
              </tr>
            </thead>
            <tbody class="tbody">
              <tr ng-repeat="kb_item in item.kb_list track by kb_item['sys_id']">
                <td ng-repeat="field in data.kb_fields">
                  <a href="{{kb_item.url}}"><span>{{kb_item[field]}}</span></a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  
  
</div>

<div class="row" ng-if="c.DEBUG==true">
  <div class="col-sm-12">
    <div class="well sm-well">
      <b>data.contributorList</b><code>{{data.contributorList}}</code><br/>
      <b>data.kb_labels:</b><code>{{data.kb_labels}}</code><br/>
      <b></b><code></code><br/>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
